name: CI - Selenium BDD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      env:
        description: 'Environment to run tests'
        required: true
        default: 'qa'
        type: choice
        options:
          - dev
          - qa
          - prod
      cucumberTags:
        description: 'Cucumber tags to run (optional)'
        required: false
        default: ''

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.env }}

    strategy:
      matrix:
        java: [23]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}
          cache: 'maven'

      - name: Show Java & Maven
        run: |
          java -version
          mvn -v

      - name: Detect browser from config and install it
        # this step reads src/main/resources/config-<env>.properties to find browser=...
        run: |
          set -e
          CONFIG_FILE="src/main/resources/config-${{ github.event.inputs.env }}.properties"
          echo "Checking config file: $CONFIG_FILE"
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "Config file not found -> defaulting to chrome"
            BROWSER="chrome"
          else
            BROWSER=$(grep -E '^browser=' "$CONFIG_FILE" | cut -d'=' -f2 | tr -d '\r' | tr '[:upper:]' '[:lower:]')
            if [ -z "$BROWSER" ]; then
              echo "No browser entry found in config file -> defaulting to chrome"
              BROWSER="chrome"
            fi
          fi
          echo "Detected browser: $BROWSER"

          if [ "$BROWSER" = "chrome" ] || [ "$BROWSER" = "chromium" ]; then
            echo "Installing chromium-browser..."
            sudo apt-get update
            sudo apt-get install -y chromium-browser
            chromium-browser --version || true

          elif [ "$BROWSER" = "edge" ] || [ "$BROWSER" = "microsoft-edge" ]; then
            echo "Installing Microsoft Edge (stable)..."
            sudo apt-get update
            sudo apt-get install -y wget gnupg apt-transport-https ca-certificates
            # Add Microsoft apt key and repo
            wget -q -O - https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
            sudo sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main" > /etc/apt/sources.list.d/microsoft-edge.list'
            sudo apt-get update
            sudo apt-get install -y microsoft-edge-stable
            microsoft-edge --version || true

          elif [ "$BROWSER" = "firefox" ]; then
            echo "Installing Firefox..."
            sudo apt-get update
            sudo apt-get install -y firefox
            firefox --version || true

          else
            echo "Unknown browser '$BROWSER' - defaulting to chromium-browser"
            sudo apt-get update
            sudo apt-get install -y chromium-browser
            chromium-browser --version || true
          fi
        shell: bash

      - name: Run tests (mvn)
        env:
          API_KEY: ${{ secrets.API_KEY }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          echo "Running tests for env=${{ github.event.inputs.env }}"
          # Pass cucumber tags only if provided
          if [ -z "${{ github.event.inputs.cucumberTags }}" ]; then
            mvn -B -Denv=${{ github.event.inputs.env }} -DretryCount=1 test
          else
            mvn -B -Denv=${{ github.event.inputs.env }} -Dcucumber.filter.tags="${{ github.event.inputs.cucumberTags }}" -DretryCount=1 test
          fi

      - name: Ensure reports folder exists
        run: mkdir -p reports

      - name: Upload artifacts (reports + summary)
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ github.event.inputs.env }}
          path: |
            reports/**
            target/cucumber.json
            target/cucumber-reports.html
            reports/summary.json

      - name: Generate Allure report (optional)
        if: success()
        run: |
          mvn allure:report || echo "Allure plugin not configured or failed"

      - name: Upload Allure report (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ github.event.inputs.env }}
          path: target/site/allure-maven-plugin/**
