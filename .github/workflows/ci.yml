name: CI - Selenium BDD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      env:
        description: 'Environment to run tests'
        required: true
        default: 'qa'
        type: choice
        options:
          - dev
          - qa
          - prod
      cucumberTags:
        description: 'Cucumber tags to run (optional)'
        required: false
        default: ''

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.env || 'qa' }}

    strategy:
      matrix:
        java: [23]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}
          cache: 'maven'

      - name: Show Java & Maven
        run: |
          java -version
          mvn -v

      - name: Detect browser from config and install it
        run: |
          set -e
          CONFIG_FILE="src/main/resources/config-${{ github.event.inputs.env }}.properties"
          echo "Checking config file: $CONFIG_FILE"
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "Config not found -> default chrome"
            BROWSER="chrome"
          else
            BROWSER=$(grep -E '^browser=' "$CONFIG_FILE" | cut -d'=' -f2 | tr -d '\r' | tr '[:upper:]' '[:lower:]')
            if [ -z "$BROWSER" ]; then
              echo "browser= not set -> default chrome"
              BROWSER="chrome"
            fi
          fi
          echo "Detected browser: $BROWSER"

          if [ "$BROWSER" = "chrome" ] || [ "$BROWSER" = "chromium" ]; then
            sudo apt-get update -y
            sudo apt-get install -y chromium-browser
            chromium-browser --version || true
          elif [ "$BROWSER" = "edge" ] || [ "$BROWSER" = "microsoft-edge" ]; then
            sudo apt-get update -y
            sudo apt-get install -y wget gnupg apt-transport-https ca-certificates
            wget -q -O - https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
            echo "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main" | sudo tee /etc/apt/sources.list.d/microsoft-edge.list
            sudo apt-get update -y
            sudo apt-get install -y microsoft-edge-stable
            microsoft-edge --version || true
          elif [ "$BROWSER" = "firefox" ]; then
            sudo apt-get update -y
            sudo apt-get install -y firefox
            firefox --version || true
          else
            sudo apt-get update -y
            sudo apt-get install -y chromium-browser
            chromium-browser --version || true
          fi
        shell: bash

      - name: Run tests (mvn)
        env:
          API_KEY: ${{ secrets.API_KEY }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          set -euo pipefail

          ENV_TO_USE="${{ github.event.inputs.env || 'qa' }}"
          TAGS="${{ github.event.inputs.cucumberTags || '' }}"

          echo "Running tests for env='${ENV_TO_USE}' (event='${{ github.event_name }}')"

          # Prevent accidental prod runs on push/PR
          if [ "${ENV_TO_USE}" = "prod" ] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "❌ Blocking prod run outside manual trigger!"
            exit 1
          fi

          if [ -z "${TAGS}" ]; then
            mvn -B -Denv="${ENV_TO_USE}" -DretryCount=1 test
          else
            mvn -B -Denv="${ENV_TO_USE}" -Dcucumber.filter.tags="${TAGS}" -DretryCount=1 test
          fi

      - name: Ensure reports folder exists
        run: mkdir -p reports

      - name: Upload Extent + Summary artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ github.event.inputs.env || 'qa' }}
          path: |
            reports/**
            target/cucumber.json
            target/cucumber-reports.html
            reports/summary.json

      - name: Generate Allure report (Maven plugin)
        if: always()
        run: |
          set -e
          echo "Generating Allure report..."
          # allure.results.directory is set by surefire pom config to target/allure-results
          mvn -B allure:report || echo "⚠️ Allure generation failed (no results or plugin issue)"

      - name: Upload Allure report (HTML + raw JSON results)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ github.event.inputs.env || 'qa' }}
          path: |
            target/site/allure-maven-plugin/**
            target/allure-results/**
