name: CI - Selenium BDD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      env:
        description: 'Environment to run tests'
        required: true
        default: 'qa'
        type: choice
        options:
          - dev
          - qa
          - prod
      execution:
        description: 'Execution mode'
        required: true
        default: 'local'
        type: choice
        options:
          - local
          - remote
      cucumberTags:
        description: 'Cucumber tags to run (optional)'
        required: false
        default: ''

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.env || 'qa' }}

    strategy:
      matrix:
        java: [23]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}
          cache: maven

      - name: Show Java & Maven
        run: |
          java -version
          mvn -v

      # ---------------- INSTALL BROWSER ONLY FOR LOCAL ----------------
      - name: Detect browser and install (LOCAL only)
        if: ${{ github.event.inputs.execution != 'remote' }}
        run: |
          set -e
          CONFIG_FILE="src/main/resources/config-${{ github.event.inputs.env }}.properties"

          if [ -f "$CONFIG_FILE" ]; then
            BROWSER=$(grep -E '^browser=' "$CONFIG_FILE" | cut -d'=' -f2 | tr -d '\r' | tr '[:upper:]' '[:lower:]')
          fi

          BROWSER=${BROWSER:-chrome}
          echo "Installing browser: $BROWSER"

          sudo apt-get update -y

          if [ "$BROWSER" = "chrome" ] || [ "$BROWSER" = "chromium" ]; then
            sudo apt-get install -y chromium-browser
          elif [ "$BROWSER" = "edge" ]; then
            sudo apt-get install -y wget gnupg apt-transport-https ca-certificates
            wget -q -O - https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
            echo "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main" | sudo tee /etc/apt/sources.list.d/microsoft-edge.list
            sudo apt-get update -y
            sudo apt-get install -y microsoft-edge-stable
          elif [ "$BROWSER" = "firefox" ]; then
            sudo apt-get install -y firefox
          else
            sudo apt-get install -y chromium-browser
          fi

      # ---------------- RUN TESTS ----------------
      - name: Run tests (mvn)
        env:
          API_KEY: ${{ secrets.API_KEY }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

          # BrowserStack Secrets (safe even if not used)
          BS_USERNAME: ${{ secrets.BS_USERNAME }}
          BS_ACCESS_KEY: ${{ secrets.BS_ACCESS_KEY }}

        run: |
          set -euo pipefail

          ENV_TO_USE="${{ github.event.inputs.env || 'qa' }}"
          EXEC_MODE="${{ github.event.inputs.execution || 'local' }}"
          TAGS="${{ github.event.inputs.cucumberTags || '' }}"

          echo "Environment: $ENV_TO_USE"
          echo "Execution mode: $EXEC_MODE"

          # Prevent accidental prod run
          if [ "$ENV_TO_USE" = "prod" ] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "❌ Blocking prod run outside manual trigger!"
            exit 1
          fi

          if [ -z "$TAGS" ]; then
            mvn -B \
              -Denv="$ENV_TO_USE" \
              -Dexecution="$EXEC_MODE" \
              -DretryCount=1 test
          else
            mvn -B \
              -Denv="$ENV_TO_USE" \
              -Dexecution="$EXEC_MODE" \
              -Dcucumber.filter.tags="$TAGS" \
              -DretryCount=1 test
          fi

      # ---------------- REPORTS ----------------
      - name: Ensure reports folder exists
        run: mkdir -p reports

      - name: Upload Extent + Summary artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ github.event.inputs.env || 'qa' }}
          path: |
            reports/**
            target/cucumber.json
            target/cucumber-reports.html
            reports/summary.json

      - name: Generate Allure report
        if: always()
        run: |
          mvn -B allure:report || echo "⚠️ Allure generation failed"

      - name: Upload Allure report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ github.event.inputs.env || 'qa' }}
          path: |
            target/site/allure-maven-plugin/**
            target/allure-results/**
